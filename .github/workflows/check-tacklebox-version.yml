name: Ensure Tacklebox Schemas Version

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    check-tacklebox-version:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Get latest tacklebox-schemas version
              id: latest
              run: |
                  LATEST_VERSION=$(npm view tacklebox-schemas version)
                  echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

            - name: Check tacklebox-schemas version
              env:
                  LATEST: ${{ steps.latest.outputs.latest_version }}
              run: |
                  INSTALLED_PATH=$(npm list tacklebox-schemas --parseable=true --depth=0)
                  INSTALLED_VERSION=$(npm list tacklebox-schemas --depth=0 --json | jq -r '.dependencies["tacklebox-schemas"].version')

                  echo "Installed version: $INSTALLED_VERSION"
                  echo "Latest version: $LATEST"

                  if [ "$INSTALLED_VERSION" != "$LATEST" ]; then
                    echo "::error file=package.json::tacklebox-schemas version mismatch. Expected $LATEST, found $INSTALLED_VERSION" 
                    echo "Run 'npm install tacklebox-schemas@latest' to fix."
                    exit 1
                  else
                    echo "tacklebox-schemas version is up-to-date"
                  fi
